<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
  <meta name="theme-color" content="#0E2A53">
  <title>OpenCase Field App</title>
  
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <style>
    /* --- CORE VARIABLES --- */
    :root{ --brand:#0E2A53; --accent:#7BC043; --bg:#f6f8fb; --card:#fff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb; --header-height:60px; }
    *{box-sizing:border-box}
    
    /* --- BASE LAYOUT --- */
    body { margin:0; font-family:Inter,system-ui,sans-serif; background:var(--bg); color:var(--text); padding-top:var(--header-height); height:100vh; overflow:hidden; } 
    .scroll-container { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 40px; } 
    .hidden { display: none !important; }
    
    /* --- BUTTONS --- */
    .btn { background:var(--brand); color:#fff; padding:10px 16px; border-radius:10px; border:none; cursor:pointer; font-weight:600; font-size:14px; display:inline-flex; align-items:center; justify-content:center; gap:6px; transition: opacity 0.2s; }
    .btn:active { opacity: 0.8; }
    .btn:disabled { background:#9ca3af; cursor:not-allowed; }
    .btn-outline { background:#fff; color:var(--brand); border:1px solid var(--brand); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    
    /* --- HEADER & DRAWER --- */
    .app-header { position: fixed; top:0; left:0; right:0; height:var(--header-height); background: #fff; border-bottom:1px solid var(--border); display: flex; align-items: center; padding: 0 16px; z-index: 1000; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .menu-btn { font-size: 24px; cursor: pointer; color: var(--brand); }
    .app-title { font-size: 18px; font-weight: 800; color: var(--brand); }
    
    .drawer-overlay { position: fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1100; opacity:0; pointer-events:none; transition:opacity 0.3s; }
    .drawer-overlay.open { opacity:1; pointer-events:auto; }
    .drawer { position: fixed; top:0; left:0; bottom:0; width:280px; background:#fff; transform:translateX(-100%); transition:transform 0.3s; z-index:1200; display:flex; flex-direction:column; }
    .drawer.open { transform:translateX(0); }
    .drawer-header { padding:20px; border-bottom:1px solid var(--border); background:var(--brand); color:#fff; }
    .nav-item { padding: 14px 20px; cursor: pointer; font-weight: 600; display: flex; gap: 12px; }
    .nav-item.active { background: #e0e7ff; color: var(--brand); border-right: 4px solid var(--brand); }

    /* --- DATA VIEWS --- */
    .container { width:100%; max-width:1200px; margin:0 auto; padding:16px; }
    .main-tabs { display:flex; gap:8px; margin-bottom:16px; background:#e5e7eb; padding:4px; border-radius:12px; }
    .main-tab { flex:1; text-align:center; padding:10px; font-size:13px; font-weight:600; color:var(--muted); border-radius:8px; cursor:pointer; }
    .main-tab.active { background:#fff; color:var(--brand); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; }
    .filters { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:12px; }
    .field { display:flex; flex-direction:column; gap:6px; }
    label { font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; }
    select, input { padding:10px; border:1px solid var(--border); border-radius:8px; width:100%; background: #fff; }
    
    /* --- TABLE & LIST --- */
    .list-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .table-container { overflow-x:auto; background: #fff; border-radius: 8px; border: 1px solid var(--border); }
    table { width:100%; border-collapse: collapse; }
    th { background:#f9fafb; text-align:left; padding:12px; font-size:12px; color:var(--muted); border-bottom:1px solid var(--border); white-space:nowrap; text-transform: uppercase; }
    td { padding:10px 12px; border-bottom:1px solid var(--border); font-size:13px; color: #374151; }
    
    /* Mobile Card View */
    @media (max-width: 768px) {
      .desktop-table { display: none; }
      .mobile-card { background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 12px; display: flex; flex-direction: column; gap: 8px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
      .m-card-header { display:flex; justify-content:space-between; border-bottom:1px solid #f3f4f6; padding-bottom:8px; align-items: center; }
      .m-meter { font-weight:700; color:var(--brand); font-size: 15px; }
      .m-status { font-size:11px; background:#f3f4f6; padding:2px 8px; border-radius:99px; color: var(--muted); font-weight: 500; }
      .m-row { display:flex; justify-content:space-between; font-size:13px; line-height: 1.4; }
      .m-label { color:var(--muted); font-size: 12px; }
      .m-val { font-weight:500; text-align:right; color: var(--text); }
      .m-footer { margin-top:4px; padding-top:10px; border-top:1px dashed var(--border); display:flex; gap:8px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    }
    @media (min-width: 769px) { .mobile-only { display: none; } }
    
    .pager { display:flex; gap:12px; justify-content:center; margin-top:20px; align-items:center; }
    .link { color:var(--brand); cursor:pointer; font-weight:600; padding:8px 16px; background:#e0e7ff; border-radius:8px; transition: background 0.2s; }
    .link:hover { background: #c7d2fe; }

    /* --- DASHBOARD --- */
    .dash-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:16px; }
    .dash-panel { border-radius:12px; border:1px solid var(--border); padding:16px; background:#fff; display:flex; flex-direction:column; }
    .universal-panel { grid-column: span 2; min-height: 400px; }
    @media(max-width:900px){ .universal-panel { grid-column: span 1; } }
    .metric-line { display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #f3f4f6; font-size: 14px; }
    .metric-val { font-weight:700; color:var(--brand); }

    /* --- LOADING & MODALS --- */
    #loadingOverlay { position: fixed; inset:0; background: rgba(255,255,255,0.95); z-index: 3000; display: flex; flex-direction:column; justify-content: center; align-items: center; backdrop-filter: blur(2px); transition:opacity 0.2s; }
    .spinner { width:40px; height:40px; border:4px solid #e5e7eb; border-top-color:var(--brand); border-radius:50%; animation:spin 0.8s linear infinite; margin-bottom:16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* FORM VIEW (IFRAME) */
    #viewForm { position: fixed; inset: 0; top: var(--header-height); background: #fff; z-index: 2050; display: flex; flex-direction: column; }
    .form-header { padding: 10px 16px; border-bottom: 1px solid var(--border); background: #f9fafb; display: flex; align-items: center; gap: 12px; }
    .form-frame-container { flex: 1; width: 100%; height: 100%; overflow: hidden; background: #fff; }
    iframe { width: 100%; height: 100%; border: none; }

    /* --- UNIFIED FULL SCREEN MAP VIEW (ROBUST MOBILE) --- */
    #viewNavigation {
      position: fixed;
      inset: 0; /* Full Screen coverage */
      top: 0; 
      background: #fff;
      z-index: 2000; /* Above everything else */
      display: flex;
      flex-direction: column;
    }
    
    .nav-header {
      position: absolute;
      top: 12px; left: 12px; right: 12px;
      z-index: 999;
      display: flex;
      justify-content: space-between;
      pointer-events: none; /* Allow clicks to map */
    }
    
    .nav-ctrl-group {
      pointer-events: auto;
      display: flex;
      gap: 8px;
    }

    .nav-btn {
      background: #fff;
      color: #374151;
      border: 1px solid rgba(0,0,0,0.1);
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      font-weight: 600;
      font-size: 13px;
      padding: 8px 14px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .nav-btn:active { transform: scale(0.98); }
    .nav-btn.primary { color: #4285F4; border-color: #4285F4; }

    #navMapDiv { flex: 1; width: 100%; height: 100%; background: #e5e7eb; }

    /* --- MAP POPUP & MARKER STYLES --- */
    .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 3px 14px rgba(0,0,0,0.2); }
    .leaflet-popup-content { margin: 12px; line-height: 1.5; font-size: 13px; }
    
    /* Custom Popup Buttons */
    .popup-btn-row { display: flex; gap: 6px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
    .popup-btn { flex: 1; text-align: center; padding: 6px 4px; border-radius: 4px; font-size: 11px; font-weight: 600; text-decoration: none; border: 1px solid #e5e7eb; background: #fff; color: #374151; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; }
    .popup-btn.fill-form { background: var(--accent); color: #fff; border: none; }
    .popup-btn.live-route { border-color: #4285F4; color: #4285F4; }

    /* GPS PULSING MARKER (Bike Style) */
    .gps-puck {
      width: 22px; height: 22px;
      background: #4285F4;
      border: 3px solid #fff;
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      position: relative;
    }
    .gps-puck::after {
      content: '';
      display: block;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 60px; height: 60px;
      background: rgba(66, 133, 244, 0.3);
      border-radius: 50%;
      animation: pulse 2s ease-out infinite;
      z-index: -1;
      pointer-events: none;
    }
    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0.8; }
      100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
    }
    
    /* Clean up Leaflet Routing Machine UI */
    .leaflet-routing-container { display: none !important; }
  </style>

  <script>
    // --- APP CONFIGURATION ---
    const API_URL = "https://script.google.com/macros/s/AKfycbx5W8xXL51bu-0PqM0KBcztUMixZtoNARjVn8hefHbPZi-wvT4iPyX6dWAR1JgWA7TQXw/exec"; 
    
    // --- APP STATE ---
    const state = { 
      view: 'home', 
      subTab: 'pendingVisit', 
      page: 1, 
      pageSize: 50, 
      filters: {}, 
      tree: {}, 
      total: 0, 
      formUrl: '' 
    };

    // --- GOOGLE SCRIPT PROXY ---
    if (typeof google === 'undefined' || !google.script) {
      window.google = { script: { run: { withSuccessHandler: function(onSuccess) { return { withFailureHandler: function(onFailure) { return new Proxy({}, { get: function(target, prop) { return function(payload) { fetch(API_URL, { method: "POST", headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify({ action: prop, payload: payload }) }).then(r => { if(!r.ok) throw new Error(`Server Error: ${r.status}`); return r.text(); }).then(text => { try { const data = JSON.parse(text); if(data && data.error) { if(onFailure) onFailure(new Error(data.error)); } else { onSuccess(data); } } catch(e) { if(text.includes("<html")) throw new Error("PERMISSION ERROR: Redeploy Script as 'Anyone'."); throw new Error("INVALID RESPONSE"); } }).catch(err => { if(onFailure) onFailure(err); }); }; } }); } }; } } } };
    }

    const el = id => document.getElementById(id);

    // --- INITIALIZATION ---
    window.addEventListener('load', () => {
      loadState(); 
      setupDrawer(); 
      loadFilters(); 
      loadFormConfig();
    });

    // --- STATE MANAGEMENT ---
    function loadState() {
      try { const s = JSON.parse(localStorage.getItem('opencase_v3_state')); if(s) { if(s.view)state.view=s.view==='dashboard'?'dashboard':'home'; if(s.subTab)state.subTab=s.subTab; if(s.filters)state.filters=s.filters; } } catch(e){}
    }
    function saveState() {
      const s = { view:state.view, subTab:state.subTab, filters:{ zone:el('zone').value, circle:el('circle').value, division:el('division').value, subdivision:el('subdivision').value, substation:el('substation').value, feeder:el('feeder').value, search:el('search').value, nonComm:el('nonCommFilter').value, sat:el('satFilter').value } };
      localStorage.setItem('opencase_v3_state', JSON.stringify(s));
    }
    function loadFormConfig() { google.script.run.withSuccessHandler(res => { state.formUrl = res.visitFormUrl; }).withFailureHandler(e=>console.log("Form config error",e)).getFormConfiguration(); }

    // --- NAVIGATION & UI ---
    function setupDrawer() { const d=el('drawer'), ov=el('drawerOverlay'); el('menuBtn').onclick=()=>{d.classList.add('open');ov.classList.add('open');}; ov.onclick=()=>{d.classList.remove('open');ov.classList.remove('open');}; updateNavUI(); updateTabsUI(); }
    function navTo(v) { if(v === 'home' && !el('viewForm').classList.contains('hidden')) { closeForm(); } state.view=v; updateNavUI(); el('drawer').classList.remove('open'); el('drawerOverlay').classList.remove('open'); saveState(); if(v==='dashboard')fetchDashboard(); else fetchData(true); }
    function updateNavUI() { el('viewHome').classList.add('hidden'); el('viewDashboard').classList.add('hidden'); document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); if(state.view==='dashboard'){ el('viewDashboard').classList.remove('hidden'); el('pageTitle').textContent='Dashboard'; document.querySelectorAll('.nav-item')[1].classList.add('active'); } else { el('viewHome').classList.remove('hidden'); el('pageTitle').textContent='Cases List'; document.querySelectorAll('.nav-item')[0].classList.add('active'); } }
    function switchSubTab(t) { state.subTab=t; updateTabsUI(); saveState(); fetchData(true); }
    function updateTabsUI() { el('tabPending').classList.toggle('active', state.subTab==='pendingVisit'); el('tabResolved').classList.toggle('active', state.subTab!=='pendingVisit'); }
    function showError(msg) { el('loadingOverlay').classList.add('hidden'); alert(msg); }

    // --- FORM OVERLAY LOGIC ---
    function openForm(url) {
      if(!url) { alert("Form URL not configured."); return; }
      let embedUrl = url;
      if(url.includes('viewform') && !url.includes('embedded=true')) { embedUrl += (url.includes('?') ? '&' : '?') + 'embedded=true'; }
      el('formFrame').src = embedUrl; el('viewForm').classList.remove('hidden');
    }
    function closeForm() { el('viewForm').classList.add('hidden'); el('formFrame').src = "about:blank"; }

    // --- DATA LOADING & FILTERING ---
    function loadFilters(){
      google.script.run.withSuccessHandler(res => {
          state.tree=res.tree; state.zones=res.zones; state.subMap=res.subdivisionsMap; state.substMap=res.substationsMap; state.feedMap=res.feedersMap;
          setOptions(el('nonCommFilter'), res.nonCommOptions); setOptions(el('satFilter'), res.satOptions);
          // Restore filters
          ['nonComm','sat','zone','circle','division','subdivision','substation','feeder','search'].forEach(k => { if(state.filters[k]) { const e=el(k.includes('Filter')?k:k==='search'?'search':k); if(e)e.value=state.filters[k]; } });
          updateCircles(); updateDivisions(); updateSubLevels(); // Cascade updates
          el('loadingOverlay').classList.add('hidden');
          if(state.view==='dashboard')fetchDashboard(); else fetchData(true);
        })
        .withFailureHandler(err => showError("Init Failed: " + err.message))
        .getFilterTree();
    }
    const setOptions = (sel, arr) => { const prev=sel.value; sel.innerHTML=`<option value="">All</option>`+(arr||[]).map(v=>`<option>${v}</option>`).join(''); if([...sel.options].some(o=>o.value===prev))sel.value=prev; }
    
    // Filter Cascade Logic
    function updateCircles(){ const z=(el('zone').value||'').trim(); const circles=(z&&state.tree[z])?Object.keys(state.tree[z]).sort():[]; setOptions(el('circle'),circles); if(!circles.includes(el('circle').value))el('circle').value=''; updateDivisions(); }
    function updateDivisions(){ const z=el('zone').value, c=el('circle').value; const divs=(z&&c&&state.tree[z][c])?state.tree[z][c]:[]; setOptions(el('division'),divs); if(!divs.includes(el('division').value))el('division').value=''; updateSubLevels(); }
    function updateSubLevels(){ const z=el('zone').value, c=el('circle').value, d=el('division').value; const sKey=[z,c,d].join('||'); setOptions(el('subdivision'),state.subMap[sKey]||[]); const subd=el('subdivision').value; const stKey=[z,c,d,subd].join('||'); setOptions(el('substation'),state.substMap[stKey]||[]); const subst=el('substation').value; const fKey=[z,c,d,subd,subst].join('||'); setOptions(el('feeder'),state.feedMap[fKey]||[]); }

    // Events
    ['zone','circle','division','subdivision','substation','feeder','nonCommFilter','satFilter'].forEach(id=>el(id).onchange = () => { if(id==='zone')updateCircles(); else if(id==='circle')updateDivisions(); else if(id!=='nonCommFilter'&&id!=='satFilter') updateSubLevels(); saveState(); });
    el('btnApply').onclick = () => { state.page=1; saveState(); if(state.view==='dashboard')fetchDashboard(); else fetchData(true); };
    el('btnClear').onclick = () => { ['zone','circle','division','subdivision','substation','feeder','search','nonCommFilter','satFilter'].forEach(id=>el(id).value=''); updateCircles(); state.filters={}; saveState(); el('btnApply').click(); };
    el('toggleFilters').onclick = () => el('filterContainer').classList.toggle('hidden');

    function buildPayload() { return { zone:el('zone').value, circle:el('circle').value, division:el('division').value, subdivision:el('subdivision').value, substation:el('substation').value, feeder:el('feeder').value, search:el('search').value, nonComm:el('nonCommFilter').value, sat:el('satFilter').value, page:state.page, pageSize:state.pageSize, visitMode:state.subTab }; }

    // --- LIST & TABLE RENDERING ---
    function fetchData(reset) {
      if(reset) state.page=1; el('tableLoader').classList.remove('hidden'); el('tbody').innerHTML=''; el('mobileList').innerHTML='';
      google.script.run.withSuccessHandler(res => { renderData(res); el('tableLoader').classList.add('hidden'); })
      .withFailureHandler(err => { el('tableLoader').innerHTML=`<span style="color:red">Error: ${err.message}</span>`; })
      .getVisitCases(buildPayload());
    }

    const forcedOrder = ["New_Meter","Non_Never_Comm","Zone","Circle","Division","Subdivision","Substation Name","Feeder Name","DT Name","Contractor_Name","Latitude","Longitude","MI_Date","SAT/NON-SAT","Pre-Paid Proposed","Visit Date","Visit Done by","Field Visit Remarks","Material Required","Resolved Status"];

    function renderData(res) {
      state.total = res.total; el('countDisplay').textContent = `${res.total} Cases`;
      el('pageInfo').textContent = `${Math.min(res.total, (res.page-1)*res.pageSize+1)} - ${Math.min(res.total, res.page*res.pageSize)}`;
      if(!res.rows.length) { el('mobileList').innerHTML='<div style="padding:20px;text-align:center;color:var(--muted)">No records found.</div>'; return; }

      const idx = Object.fromEntries(res.headers.map((h,i)=>[h,i]));
      const displayed = forcedOrder.filter(k=>idx[k]!==undefined);

      // Desktop Table Headers
      let thHtml = displayed.map(h=>`<th>${h}</th>`).join('');
      thHtml += '<th>Action</th>'; // Always show action column
      el('thead').innerHTML = `<tr>${thHtml}</tr>`;

      // Desktop Rows
      el('tbody').innerHTML = res.rows.map(r => {
        let trHtml = displayed.map(k=>`<td>${r[idx[k]]||''}</td>`).join('');
        const lat = r[idx['Latitude']], lng = r[idx['Longitude']];
        const hasGps = (lat && lng && lat!='-' && lat!=0);
        
        let btns = `<div style="display:flex;gap:4px">`;
        if(state.formUrl) btns += `<button onclick="openForm('${state.formUrl}')" class="btn-outline btn-sm">Fill Form</button>`;
        if(hasGps) btns += `<button onclick="startNav(${lat}, ${lng})" class="btn-outline btn-sm" style="color:#4285F4;border-color:#4285F4">Live Route</button>`;
        btns += `</div>`;
        
        return `<tr>${trHtml}<td>${btns}</td></tr>`;
      }).join('');

      // Mobile Card Rows
      el('mobileList').innerHTML = res.rows.map(r => {
        const get = k => r[idx[k]]||'-';
        const lat = get('Latitude'), lng = get('Longitude');
        const hasGps = (lat && lng && lat!='-' && lat!=0);
        
        // Buttons Logic
        let actionBtns = '';
        if(state.formUrl) actionBtns += `<button onclick="openForm('${state.formUrl}')" class="btn-outline btn-sm">Fill Form</button>`;
        if(hasGps) actionBtns += `<button onclick="startNav(${lat}, ${lng})" class="btn-outline btn-sm" style="color:#4285F4;border-color:#4285F4">Live Route</button>`;
        if(hasGps) actionBtns += `<a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank" class="btn-outline btn-sm" style="text-decoration:none">Nav</a>`;

        let extra = '';
        if(state.subTab !== 'pendingVisit') {
          extra = `<div style="background:#f9fafb;padding:8px;border-radius:6px;margin-top:4px;"><div class="m-row"><span class="m-label">Visit Date:</span><span class="m-val">${get('Visit Date')}</span></div><div class="m-row"><span class="m-label">By:</span><span class="m-val">${get('Visit Done by')}</span></div><div class="m-row"><span class="m-label">Status:</span><span class="m-val" style="color:var(--brand);font-weight:700">${get('Resolved Status')}</span></div></div>`;
        }

        return `<div class="mobile-card">
          <div class="m-card-header"><div class="m-meter">${get('New_Meter')}</div><div class="m-status">${get('Non_Never_Comm')}</div></div>
          <div class="m-row"><span class="m-label">Zone/Cir</span><span class="m-val">${get('Zone')} / ${get('Circle')}</span></div>
          <div class="m-row"><span class="m-label">Div/Sub</span><span class="m-val">${get('Division')} / ${get('Subdivision')}</span></div>
          <div class="m-row"><span class="m-label">Substation</span><span class="m-val">${get('Substation Name')}</span></div>
          <div class="m-row"><span class="m-label">DT Name</span><span class="m-val">${get('DT Name')}</span></div>
          ${extra}
          <div class="m-footer">
             <div style="font-size:11px;color:var(--muted);width:100%">${get('Contractor_Name')}</div>
             <div style="display:flex;gap:8px;width:100%;justify-content:flex-end;margin-top:6px">${actionBtns}</div>
          </div>
        </div>`;
      }).join('');
    }

    el('prev').onclick = () => { if(state.page > 1) { state.page--; fetchData(false); } };
    el('next').onclick = () => { if(state.page*state.pageSize < state.total) { state.page++; fetchData(false); } };

    // --- CSV EXPORT ---
    el('btnCsv').onclick = () => {
      el('btnCsv').textContent='Exporting...'; el('btnCsv').disabled = true;
      const m = state.view==='dashboard'?'exportCsv':'exportVisitCsv';
      google.script.run.withSuccessHandler(res => {
        const csvContent = res.csv || res; 
        const blob = new Blob([csvContent], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const now = new Date();
        const pad = n => String(n).padStart(2,'0');
        const dateStr = `${pad(now.getDate())}-${pad(now.getMonth()+1)}-${now.getFullYear()}_${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
        a.href = url; a.download = `OpenCase_Export_${dateStr}.csv`; a.click();
        el('btnCsv').textContent='‚¨á CSV'; el('btnCsv').disabled = false;
      })
      .withFailureHandler(err => { alert("Export Failed: " + err.message); el('btnCsv').textContent='‚¨á CSV'; el('btnCsv').disabled = false; })[m](buildPayload());
    };

    /* ==========================================================
       UNIFIED FULL-SCREEN MAP & NAVIGATION CONTROLLER
       ========================================================== */
    let map, markersLayer, routeControl, userMarker, watchId;
    let isUserPanning = false;

    // 1. Initialize Map Logic
    function initMapEngine() {
      if (!map) {
          map = L.map('navMapDiv', { zoomControl: false });
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '&copy; OpenStreetMap'}).addTo(map);
          markersLayer = L.layerGroup().addTo(map);
          
          // User interaction detection (stops auto-follow)
          map.on('dragstart', () => { 
             if(userMarker) { // Only relevant if navigating
               isUserPanning = true; 
               el('btnRecenter').classList.remove('primary'); // Visual feedback
             }
          });
      }
      // CRITICAL: Mobile fix for grey screen
      setTimeout(() => { map.invalidateSize(); }, 200);
    }

    // 2. Open Standard Map View (Overview)
    el('btnMap').onclick = () => {
      el('btnMap').textContent='Loading...'; el('btnMap').disabled = true;
      google.script.run.withSuccessHandler(pts => { 
        launchMapView(pts); 
        el('btnMap').textContent='üó∫ Map'; el('btnMap').disabled = false; 
      })
      .withFailureHandler(err => { alert("Map Error: " + err.message); el('btnMap').textContent='üó∫ Map'; el('btnMap').disabled = false; })
      .getMapData(buildPayload());
    };

    function launchMapView(points) {
      if(!points.length) { alert("No valid GPS data."); return; }
      
      resetMapState(); // Clear routes, GPS watch
      el('viewNavigation').classList.remove('hidden'); // Show Full Screen
      el('btnRecenter').classList.add('hidden'); // Hide Recenter (only for live nav)
      
      initMapEngine();
      markersLayer.clearLayers();

      const bounds = L.latLngBounds();
      
      points.forEach(p => {
        const marker = L.marker([p.lat, p.lng]).addTo(markersLayer);
        const popupContent = createPopupHtml(p);
        marker.bindPopup(popupContent);
        bounds.extend([p.lat, p.lng]);
      });
      
      map.fitBounds(bounds, {padding:[50,50]});
    }

    // 3. Open Live Navigation Mode (Single Dest)
    window.startNav = function(destLat, destLng) {
      if (!navigator.geolocation) { alert("GPS not supported on this device."); return; }
      
      // Open View Immediately
      resetMapState();
      el('viewNavigation').classList.remove('hidden');
      el('btnRecenter').classList.remove('hidden'); // Show Recenter button
      el('btnRecenter').classList.add('primary'); // Active state
      
      initMapEngine();
      markersLayer.clearLayers();
      
      // Add Destination Marker (Static)
      // We need to fetch details for this specific point if called from list, 
      // but if we don't have the full object here, we might need to pass it.
      // For simplicity, we place a marker. If called from map popup, the marker exists.
      // If called from list, we place a generic marker.
      L.marker([destLat, destLng]).addTo(markersLayer)
        .bindPopup(`<div style="font-weight:700;margin-bottom:4px">Destination</div><button onclick="openForm('${state.formUrl}')" class="popup-btn fill-form">Fill Form</button>`).openPopup();

      // Start GPS Tracking
      const pulsingIcon = L.divIcon({ className: 'gps-puck', iconSize: [22, 22], iconAnchor: [11, 11] });
      isUserPanning = false;

      watchId = navigator.geolocation.watchPosition(pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const latlng = [lat, lng];

          if (!userMarker) {
              // FIRST FIX: Init Marker & Route
              userMarker = L.marker(latlng, {icon: pulsingIcon, zIndexOffset: 1000}).addTo(map);
              
              routeControl = L.Routing.control({
                  waypoints: [L.latLng(lat, lng), L.latLng(destLat, destLng)],
                  router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
                  lineOptions: { styles: [{color: '#4285F4', opacity: 0.8, weight: 6}] },
                  createMarker: function() { return null; }, // No extra markers
                  addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true, show: false
              }).addTo(map);
              
              // Auto-Zoom to route start
              routeControl.on('routesfound', function(e) {
                 map.fitBounds(e.routes[0].coordinates, {padding: [50, 50], animate: true});
              });

          } else {
              // UPDATE FIX
              userMarker.setLatLng(latlng);
          }

          // Smart Follow
          if (!isUserPanning) {
              map.panTo(latlng, {animate: true, easeLinearity: 0.5});
          }

      }, err => { 
        console.warn("GPS Signal Lost", err); 
      }, { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 });
    }

    // 4. Helper: Create Robust Popup Content
    function createPopupHtml(p) {
      const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}`;
      
      // Dynamic Details based on data availability (Robust for both tabs)
      let det = `<div style="display:grid;grid-template-columns:auto 1fr; gap:2px 8px; margin-bottom:8px;">`;
      if(p.z) det += `<span style="color:var(--muted)">Zone:</span> <b>${p.z}</b>`;
      if(p.sub) det += `<span style="color:var(--muted)">Subst:</span> <b>${p.sub}</b>`;
      if(p.ct) det += `<span style="color:var(--muted)">Contr:</span> <b>${p.ct}</b>`;
      if(p.st) det += `<span style="color:var(--muted)">Status:</span> <b>${p.st || 'Pending'}</b>`;
      if(p.vd) det += `<span style="color:var(--muted)">Date:</span> <b>${p.vd}</b>`;
      det += `</div>`;
      
      if(p.rmk) det += `<div style="background:#f3f4f6;padding:4px 6px;border-radius:4px;margin-bottom:6px;font-style:italic;color:#555">"${p.rmk}"</div>`;

      // Buttons (Fill Form is always available)
      let btns = `<div class="popup-btn-row">`;
      if(state.formUrl) btns += `<button onclick="openForm('${state.formUrl}')" class="popup-btn fill-form">üìù Form</button>`;
      btns += `<button onclick="startNav(${p.lat}, ${p.lng})" class="popup-btn live-route">üìç Live Route</button>`;
      btns += `<a href="${navUrl}" target="_blank" class="popup-btn">Nav ‚Üó</a>`;
      btns += `</div>`;

      return `<div style="font-size:13px; min-width:240px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #eee">
           <b style="color:var(--brand);font-size:14px">${p.nm}</b>
           <span style="background:#eee;padding:1px 6px;border-radius:4px;font-size:10px">${p.nnc}</span>
        </div>
        ${det}
        ${btns}
      </div>`;
    }

    // 5. Cleanup & Controls
    function resetMapState() {
      if(watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
      if(routeControl && map) { map.removeControl(routeControl); routeControl = null; }
      if(userMarker && map) { map.removeLayer(userMarker); userMarker = null; }
    }

    function recenterMap() {
      if(userMarker) {
          isUserPanning = false;
          el('btnRecenter').classList.add('primary');
          map.panTo(userMarker.getLatLng(), {animate: true});
      }
    }

    function closeNavigation() {
      resetMapState();
      el('viewNavigation').classList.add('hidden');
    }
  </script>

<body>
  <div id="loadingOverlay">
    <div class="spinner" id="spinner"></div>
    <div style="font-weight:600;color:var(--brand)" id="loadingText">Starting App...</div>
  </div>

  <div class="drawer-overlay" id="drawerOverlay"></div>
  <div class="drawer" id="drawer">
    <div class="drawer-header"><div class="drawer-title" style="font-weight:800;font-size:20px">OpenCase</div></div>
    <div class="nav-links">
      <div class="nav-item active" onclick="navTo('home')"><i>üè†</i> Home / List</div>
      <div class="nav-item" onclick="navTo('dashboard')"><i>bar_chart</i> Dashboard</div>
    </div>
  </div>

  <header class="app-header">
    <div class="header-left">
      <div class="menu-btn" id="menuBtn">‚ò∞</div>
      <div class="app-title" id="pageTitle">Cases</div>
    </div>
  </header>

  <div id="viewForm" class="hidden">
    <div class="form-header">
      <button class="btn btn-outline btn-sm" onclick="closeForm()">‚Üê Back</button>
      <div style="font-weight:700;color:var(--brand)">Field Form</div>
    </div>
    <div class="form-frame-container">
      <iframe id="formFrame" src="about:blank"></iframe>
    </div>
  </div>

  <div id="viewNavigation" class="hidden">
    <div class="nav-header">
      <div class="nav-ctrl-group">
        <button class="nav-btn" onclick="closeNavigation()">‚úï Exit</button>
      </div>
      <div class="nav-ctrl-group">
        <button class="nav-btn hidden" id="btnRecenter" onclick="recenterMap()">‚óé Center</button>
      </div>
    </div>
    <div id="navMapDiv"></div>
  </div>

  <div class="scroll-container" id="mainContent">
    <div class="container">
      
      <div id="viewHome">
        <div class="main-tabs">
          <div id="tabPending" class="main-tab active" onclick="switchSubTab('pendingVisit')">Pending for Visit</div>
          <div id="tabResolved" class="main-tab" onclick="switchSubTab('visitPendingResolution')">Visit completed; resolution pending</div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;align-items:center">
            <div style="font-weight:700;color:var(--brand)">Filters</div>
            <div style="font-size:12px;color:var(--brand);cursor:pointer" id="toggleFilters">Show/Hide</div>
          </div>
          <div class="filters" id="filterContainer">
            <div class="field"><label>Category</label><select id="nonCommFilter"><option value="">All</option></select></div>
            <div class="field"><label>SAT Status</label><select id="satFilter"><option value="">All</option></select></div>
            <div class="field"><label>Zone</label><select id="zone"></select></div>
            <div class="field"><label>Circle</label><select id="circle"></select></div>
            <div class="field"><label>Division</label><select id="division"></select></div>
            <div class="field"><label>Subdivision</label><select id="subdivision"></select></div>
            <div class="field"><label>Substation</label><select id="substation"></select></div>
            <div class="field"><label>Feeder</label><select id="feeder"></select></div>
            <div class="field"><label>Search</label><input id="search" placeholder="Meter/Name..."></div>
            <div class="filter-actions">
              <button id="btnApply" class="btn">Apply Filters</button>
              <button id="btnClear" class="btn btn-outline">Clear</button>
            </div>
          </div>
        </div>

        <div class="list-header">
          <div><span class="list-title" id="countDisplay">0 cases</span></div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-outline" style="padding:8px" id="btnMap">üó∫ Map</button>
            <button class="btn btn-outline" style="padding:8px" id="btnCsv">‚¨á CSV</button>
          </div>
        </div>

        <div id="tableLoader" class="hidden" style="text-align:center;padding:20px;color:var(--muted)">Loading data...</div>
        <div class="table-container desktop-table">
          <table><thead id="thead"></thead><tbody id="tbody"></tbody></table>
        </div>
        <div class="data-list mobile-only" id="mobileList"></div>

        <div class="pager">
          <div id="prev" class="link">Previous</div>
          <span id="pageInfo" style="font-size:13px;color:var(--muted)">-</span>
          <div id="next" class="link">Next</div>
        </div>
      </div>

      <div id="viewDashboard" class="hidden">
        <div style="text-align:center; padding:20px;">Dashboard data loaded via JS...</div>
      </div>
    </div>
  </div>
</body>
</html>
