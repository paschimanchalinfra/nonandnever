<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Field Visit App v2.7</title>
  <style>
    /* --- CSS STYLES --- */
    :root { --primary: #1a73e8; --bg: #f0f2f5; --card-bg: #ffffff; --text: #202124; --border: #80868b; --border-focus: #1a73e8; --err: #d93025; --ok: #188038; --warn: #f9ab00; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); font-size: 16px; }
    .container { max-width: 600px; margin: 0 auto; padding: 16px; min-height: 100vh; display: flex; flex-direction: column; }
    
    /* View Switching */
    .view-section { display: none; flex-grow: 1; }
    .view-section.active { display: block; animation: fade 0.3s ease-out; }
    @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Header */
    .app-header { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 16px; margin: -16px -16px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
    .brand { font-size: 20px; font-weight: 800; color: var(--primary); }
    .user-info { text-align: right; font-size: 13px; color: #5f6368; margin-right: 12px; }
    .btn-logout { background: #fce8e6; color: var(--err); border: 1px solid #fad2cf; padding: 6px 12px; border-radius: 6px; font-weight: 600; cursor: pointer; }
    
    /* Dashboard Buttons */
    .dash-btn { background: #fff; border: 1px solid #ddd; padding: 25px; border-radius: 12px; margin-bottom: 20px; text-align: center; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.1s; }
    .dash-btn:active { transform: scale(0.98); background: #f8f9fa; }
    .dash-btn h3 { margin: 0 0 5px; color: var(--primary); }
    .dash-btn p { margin: 0; color: #666; font-size: 13px; }

    /* Inputs */
    .sec-title { margin: 30px 0 10px; font-size: 14px; font-weight: 700; color: var(--primary); text-transform: uppercase; border-bottom: 2px solid #e8f0fe; padding-bottom: 5px; }
    label { display: block; margin: 15px 0 5px; font-weight: 600; font-size: 15px; }
    .req { color: var(--err); }
    input, select, textarea { width: 100%; padding: 14px; font-size: 16px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; appearance: none; color: #000; }
    input:focus, select:focus, textarea:focus { border-color: var(--border-focus); box-shadow: 0 0 0 3px rgba(26,115,232,0.2); outline: none; }
    select { background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23202124%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 14px center; background-size: 10px; }
    select:disabled { background-color: #e9ecef; color: #6c757d; }
    textarea { resize: vertical; min-height: 80px; }
    
    /* --- CSS FOR O&M VISIBILITY --- */
    .mat-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    .mat-table td { padding: 12px 8px; border-bottom: 1px solid #ddd; vertical-align: middle; }
    
    .mat-check { 
      width: 24px; height: 24px; cursor: pointer; accent-color: var(--primary); 
      transform: scale(1.1); margin-right: 10px;
    }
    tr.selected { background-color: #e8f0fe; }
    .mat-inp { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
    
    /* Flex Container for Composite Inputs (Dropdown + Count) */
    .mat-composite { display: flex; gap: 8px; }
    .mat-composite .mat-inp { flex-grow: 1; }
    .mat-composite input[type="number"] { width: 90px; } 

    /* Password Eye */
    .pass-wrap { position: relative; width: 100%; }
    .pass-wrap input { padding-right: 45px; }
    .pass-toggle { position: absolute; right: 0; top: 0; height: 100%; width: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #666; font-size: 18px; user-select: none; }

    /* Buttons */
    .actions { margin-top: 30px; display: flex; flex-direction: column; gap: 12px; }
    button.main { background: var(--primary); color: #fff; padding: 16px; border-radius: 50px; border: none; font-size: 18px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: opacity 0.2s; }
    button.main:disabled { background: #ccc; cursor: not-allowed; opacity: 0.7; }
    button.link { background: none; border: none; color: #5f6368; text-decoration: underline; cursor: pointer; padding: 10px; }
    
    /* Images */
    .img-box { margin-top: 10px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; text-align: center; display: none; background: #fff; }
    .img-box.show { display: block; border-style: solid; border-color: var(--border); }
    .img-box img { max-width: 100%; max-height: 250px; border-radius: 4px; }
    
    /* Messaging */
    .msg { text-align: center; margin-top: 15px; font-weight: 500; min-height: 20px; }
    .msg.err { color: var(--err); } .msg.ok { color: var(--ok); }
    
    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; place-items: center; z-index: 1000; padding: 20px; }
    .modal-overlay.open { display: grid; }
    .modal { background: #fff; padding: 25px; border-radius: 12px; width: 100%; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .modal h3 { margin: 0 0 10px; }
    .warn-box { background: #fff3e0; color: #e65100; padding: 10px; border-radius: 6px; font-size: 13px; margin: 10px 0; border: 1px solid #ffe0b2; }
    .modal-btns { text-align: right; margin-top: 20px; }
    .modal-btns button { padding: 8px 16px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; margin-left: 10px; }
    .btn-ok { background: var(--primary); color: #fff; }
    .btn-cancel { background: #f0f0f0; color: #333; border: 1px solid #ccc; }
    
    /* Conditional Sections */
    .hidden { display: none !important; }
    
    /* LOCKED SECTION for O&M Flow */
    #om-flow-locked { opacity: 0.5; pointer-events: none; transition: opacity 0.3s; }
    #om-flow-locked.unlocked { opacity: 1; pointer-events: auto; }
  </style>
</head>
<body>

<div class="container">
  
  <div id="view-login" class="view-section active">
    <div style="margin: 60px 0 40px;"><h1>Welcome</h1><p style="color:#5f6368;">Log in to continue</p></div>
    <label>Emp Code</label><input id="loginCode" type="text" placeholder="Enter ID (e.g. INTL123)">
    <label>Password</label>
    <div class="pass-wrap">
      <input id="loginPass" type="password">
      <span id="togglePass" class="pass-toggle">üëÅÔ∏è</span>
    </div>
    <div class="actions">
      <button class="main" id="btnLogin">LOGIN</button>
      <button class="link" id="btnToReset">Change Password</button>
    </div>
    <div id="loginMsg" class="msg"></div>
  </div>

  <div id="view-reset" class="view-section">
    <div style="margin: 30px 0;"><h1>Reset Password</h1></div>
    <label>Emp Code</label><input id="resetCode" type="text">
    <label>Old Password</label><input id="resetOld" type="password">
    <label>New Password</label><input id="resetNew" type="password">
    <div class="actions">
      <button class="main" id="btnDoReset">UPDATE</button>
      <button class="link" id="btnBackLogin">Back to Login</button>
    </div>
    <div id="resetMsg" class="msg"></div>
  </div>

  <div id="view-dashboard" class="view-section">
    <div class="app-header">
      <div class="brand">üìã Field Visit</div>
      <div style="display:flex;align-items:center;">
        <div class="user-info"><div id="dName" style="font-weight:700;">User</div><div id="dCode">ID</div></div>
        <button id="btnDLogout" class="btn-logout">Logout</button>
      </div>
    </div>

    <div style="margin-top: 40px;">
      <div class="dash-btn" onclick="openForm('NEW')">
        <h3>‚ú® First Time Visit</h3>
        <p>New installation report. Checks for duplicates.</p>
      </div>
      
      <div class="dash-btn" onclick="openForm('OM')">
        <h3>üõ†Ô∏è O&M Visit</h3>
        <p>Maintenance, Rectification & Material Usage.</p>
      </div>
    </div>
  </div>

  <div id="view-form" class="view-section">
    <div class="app-header">
      <div class="brand" id="formTitle">Report</div>
      <button onclick="show('view-dashboard')" class="link" style="font-size:12px;">Back</button>
    </div>

    <div class="sec-title">Location</div>
    <label>Zone <span class="req">*</span></label><select id="zone"><option value="">Select</option></select>
    <label>Circle <span class="req">*</span></label><select id="circle" disabled><option value="">Select</option></select>
    <label>Division <span class="req">*</span></label><select id="division" disabled><option value="">Select</option></select>

    <div class="sec-title">Details</div>
    <label>Meter No <span class="req">*</span></label><input id="meterNo" type="text" maxlength="10" placeholder="e.g. AL12345678">
    <div style="font-size:12px;color:#666;margin-top:4px;">Format: 2 Letters (A-Z) + 7-8 Digits</div>
    <div id="dupWarning" style="color:red; font-size:12px; margin-top:5px; font-weight:bold;"></div>
    
    <div class="sec-title">Photos</div>
    
    <div id="img-sec-new">
      <label>Meter Image <span class="req">*</span></label><input id="f_meter" type="file" accept="image/*" capture="environment"><div id="p_meter" class="img-box"><img id="i_meter"></div>
      <label>With CT <span class="req">*</span></label><input id="f_ct" type="file" accept="image/*" capture="environment"><div id="p_ct" class="img-box"><img id="i_ct"></div>
      <label>With DT & Cable <span class="req">*</span></label><input id="f_dt" type="file" accept="image/*" capture="environment"><div id="p_dt" class="img-box"><img id="i_dt"></div>
    </div>

    <div id="img-sec-om-before" class="hidden">
      <label style="color:var(--primary);">Step 1: Image Before O&M <span class="req">*</span></label>
      <input id="f_before" type="file" accept="image/*" capture="environment">
      <div id="p_before" class="img-box"><img id="i_before"></div>
    </div>

    <div id="om-flow-locked">
        <div class="sec-title">Remarks & Data</div>
        <label>Field Remark <span class="req">*</span></label><textarea id="fieldRemark" rows="1"></textarea>

        <div id="sec-mat-req">
           <label>Material Required <span class="req">*</span></label><textarea id="matReq" rows="1"></textarea>
        </div>

        <div id="sec-mat-used" class="hidden">
           <div class="sec-title">Material Used</div>
           <table class="mat-table" id="matTableBody">
             </table>
        </div>

        <label>Dependency <span class="req">*</span></label><select id="dependency"><option value="">Select</option></select>
        <label>Remark Bucket <span class="req">*</span></label><select id="remBucket" disabled><option value="">Select</option></select>
        <label>Final Bucket <span class="req">*</span></label><select id="finBucket" disabled><option value="">Select</option></select>

        <label>Rectification Status <span class="req">*</span></label><select id="rectStatus"><option value="">Select</option></select>
        
        <div id="sec-vehicle-om" class="hidden">
          <label>Vehicle use while O&M <span class="req">*</span></label>
          <select id="vehicleOM">
            <option value="">Select</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </div>

        <div id="sec-veh">
          <label>Vehicle Required <span class="req">*</span></label><select id="vehReq"><option value="">Select</option></select>
        </div>
        
        <div id="img-sec-om-after" class="hidden" style="margin-top:20px;">
          <label>Step 2: Image After O&M <span class="req">*</span></label>
          <input id="f_after" type="file" accept="image/*" capture="environment">
          <div id="p_after" class="img-box"><img id="i_after"></div>
        </div>
    </div>

    <div class="actions">
      <button class="main" id="btnSave">SUBMIT REPORT</button>
      <button class="link" id="btnSync">Refresh Options</button>
      <div id="formMsg" class="msg"></div>
    </div>
  </div>
</div>

<div id="modal" class="modal-overlay">
  <div class="modal">
    <h3 id="mTitle">Title</h3>
    <div id="mBody"></div>
    <div class="modal-btns">
      <button id="mCancel" class="btn-cancel" style="display:none;">CANCEL</button>
      <button id="mOk" class="btn-ok">OK</button>
    </div>
  </div>
</div>

<script>
  // -------------------------------------------------------------
  // UPDATE THIS URL WITH YOUR DEPLOYMENT URL
  const API_URL = "https://script.google.com/macros/s/AKfycbycPr0Ef3R4YRqgwT_jCTz_-3SNIwjyifXCCbzlZtwPEHiKeP9ofFRw9U1AgLiUW7wC/exec"; 
  // -------------------------------------------------------------

  const MATERIAL_CONFIG = [
    // UPDATED: Consolidated Smart Meter
    { id: 1, name: "3-Phase Smart Meter Installed", type: "DROPDOWN", options: ["Yes", "No"] },
    
    { id: 3, name: "3-Phase SMC Meter Box", type: "DROPDOWN", options: ["50/5A", "100/5A", "200/5A", "400/5A", "600/5A", "800/5A", "1000/5A"] },
    
    // UPDATED: CT with Dropdown Quantity (1,2,3,4)
    { id: 4, name: "Resin Type Current Transformer (CT)", type: "DROPDOWN_PLUS_DROPDOWN_COUNT", 
      options: ["50/5A", "100/5A", "200/5A", "400/5A", "600/5A", "800/5A", "1000/5A"],
      countOptions: ["1", "2", "3", "4"] 
    },
    
    { id: 5, name: "Polycarbonate Meter Seal", type: "COUNT" },
    { id: 6, name: "NIC Card (GPRS / RF)", type: "COUNT" },
    { id: 7, name: "Gateway / Router / Access Point", type: "COUNT" },
    { id: 8, name: "Sticker / Label", type: "COUNT" },
    { id: 9, name: "Others", type: "DROPDOWN", options: ["Incoming Cable Connected", "Outgoing Cable Connected", "PT Wire Connected", "Screw Tight", "Other"] }
  ];

  let currentUser = null;
  let currentMode = 'NEW'; 
  let circlesByZone={}, divisionsByPair={}, remarksByDep={}, finalsByPair={};
  const imgs = { meter:null, ct:null, dt:null, before:null, after:null };
  
  const get = id => document.getElementById(id);
  const msg = (id,t,k) => { const e=get(id); e.textContent=t; e.className='msg '+(k||''); };
  const show = (id) => { document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); get(id).classList.add('active'); window.scrollTo(0,0); };

  async function callApi(action, data = {}) {
    try {
      const response = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: action, data: data }),
        headers: { "Content-Type": "text/plain;charset=utf-8" } 
      });
      return await response.json();
    } catch (e) { console.error(e); throw new Error("Connection Failed"); }
  }

  function initAuth() {
    const s = localStorage.getItem('fv_user');
    if(s) { currentUser = JSON.parse(s); loadDashboard(); } else show('view-login');
  }

  get('btnLogin').onclick = () => {
    const c=get('loginCode').value.trim(), p=get('loginPass').value.trim();
    if(!c||!p) return msg('loginMsg','Enter credentials','err');
    msg('loginMsg','Verifying...');
    callApi('login', { empCode: c, password: p }).then(res => {
      if(res.success) { 
        currentUser={empCode:res.empCode, name:res.name}; 
        localStorage.setItem('fv_user',JSON.stringify(currentUser)); 
        msg('loginMsg',''); loadDashboard(); 
      } else msg('loginMsg', res.message, 'err');
    }).catch(e => msg('loginMsg', e.message, 'err'));
  };

  get('btnDLogout').onclick = () => { localStorage.removeItem('fv_user'); currentUser=null; show('view-login'); };
  get('btnBackLogin').onclick = () => show('view-login');
  get('togglePass').onclick = () => { const ip=get('loginPass'); ip.type = ip.type==='password'?'text':'password'; };

  function loadDashboard() {
    get('dName').textContent = currentUser.name.split(' ')[0]; get('dCode').textContent = currentUser.empCode;
    show('view-dashboard');
    if(get('zone').options.length <= 1) fetchOpts(); 
  }

  window.openForm = (mode) => {
    currentMode = mode;
    resetForm();
    get('formTitle').textContent = mode === 'NEW' ? 'New Visit' : 'O&M Visit';
    
    // Default: Unlock everything
    const locker = get('om-flow-locked');
    locker.classList.remove('unlocked'); // Reset state
    
    if (mode === 'NEW') {
      get('sec-mat-req').classList.remove('hidden');
      get('sec-mat-used').classList.add('hidden');
      get('img-sec-new').classList.remove('hidden');
      get('img-sec-om-before').classList.add('hidden');
      get('img-sec-om-after').classList.add('hidden');
      get('sec-vehicle-om').classList.add('hidden'); // Hide O&M Vehicle
      get('sec-veh').classList.remove('hidden'); // Show New Visit Vehicle
      
      // Unlock immediately for New Visit
      locker.classList.add('unlocked');
      
    } else {
      // O&M: Lock everything initially
      locker.classList.remove('unlocked');
      
      get('sec-mat-req').classList.add('hidden');
      get('sec-mat-used').classList.remove('hidden');
      get('img-sec-new').classList.add('hidden');
      
      get('img-sec-om-before').classList.remove('hidden');
      get('img-sec-om-after').classList.remove('hidden'); 
      
      get('sec-vehicle-om').classList.remove('hidden'); // Show O&M Vehicle
      get('sec-veh').classList.add('hidden'); // Hide New Visit Vehicle
      
      renderOMTable();
    }
    show('view-form');
  };

  function unlockOMFlow() {
    if(currentMode === 'OM') {
      get('om-flow-locked').classList.add('unlocked');
    }
  }

  get('meterNo').onblur = async function() {
    const m = this.value.trim();
    const btn = get('btnSave');
    get('dupWarning').textContent = '';
    btn.disabled = false;

    if (m.length < 5) return; 
    
    if (currentMode === 'NEW') {
      get('dupWarning').textContent = 'Checking availability...';
      get('dupWarning').style.color = 'orange';
      try {
        const res = await callApi('checkMeter', { meterNo: m });
        if (res.exists) {
          const d = res.meta;
          btn.disabled = true;
          get('dupWarning').textContent = '‚ö†Ô∏è Meter already visited. Submission blocked.';
          get('dupWarning').style.color = 'red';
          const html = `
            <div class="warn-box">
               <strong>Already Submitted By:</strong><br>
               Name: ${d.name}<br>Role: ${d.designation}<br>
               <span style="color:#d93025; font-weight:bold;">Mobile: ${d.mobile}</span><br>
               Date: ${d.date}<br>Meter: ${d.meter}
            </div>
            <p style="font-size:13px">Use <b>O&M Visit</b> if this is maintenance.</p>
          `;
          modal('Duplicate Entry Detected', html);
        } else { get('dupWarning').textContent = ''; }
      } catch(e) { console.log(e); }
    }
  };

  function renderOMTable() {
    const tb = get('matTableBody'); tb.innerHTML = '';
    MATERIAL_CONFIG.forEach((item, idx) => {
      let inputHtml = '';
      if(item.type === 'COUNT') {
        inputHtml = `<input type="number" class="mat-inp mat-val" placeholder="Qty" min="1">`;
      } else if(item.type === 'DROPDOWN') {
        inputHtml = `<select class="mat-inp mat-val"><option value="">Select Option</option>${item.options.map(o=>`<option>${o}</option>`).join('')}</select>`;
      } else if(item.type === 'DROPDOWN_PLUS_DROPDOWN_COUNT') {
        // NEW TYPE: Renders Dropdown Rating + Dropdown Count
        inputHtml = `
          <div class="mat-composite">
            <select class="mat-inp mat-val-drop">
              <option value="">Select Rating</option>${item.options.map(o=>`<option>${o}</option>`).join('')}
            </select>
            <select class="mat-inp mat-val-count" style="width:90px;">
              <option value="">Qty</option>${item.countOptions.map(o=>`<option>${o}</option>`).join('')}
            </select>
          </div>
        `;
      }

      const row = `
        <tr data-id="${item.id}" data-type="${item.type}" data-name="${item.name}">
          <td width="40" style="vertical-align: middle; text-align: center;"><input type="checkbox" class="mat-check"></td>
          <td><div style="font-weight:600;margin-bottom:6px;">${item.name}</div><div class="mat-ctrl" style="display:none;">${inputHtml}</div></td>
        </tr>`;
      tb.insertAdjacentHTML('beforeend', row);
    });
    
    // Add Listeners
    tb.querySelectorAll('.mat-check').forEach(ck => {
      ck.onchange = (e) => {
        const tr = e.target.closest('tr');
        const ctrl = tr.querySelector('.mat-ctrl');
        const inp = tr.querySelector('.mat-val') || tr.querySelector('.mat-val-drop');
        if (e.target.checked) {
          ctrl.style.display = 'block'; tr.classList.add('selected'); if(inp) inp.focus();
        } else {
          ctrl.style.display = 'none'; tr.classList.remove('selected'); 
          tr.querySelectorAll('input, select').forEach(el => el.value = '');
        }
        
        // AUTO-LOGIC TRIGGER: If SMC Box is changed
        const name = tr.dataset.name;
        if(name === "3-Phase SMC Meter Box") {
          handleSMCLogic(e.target.checked);
        }
      };
    });
  }

  // --- AUTOMATED DEPENDENCY LOGIC ---
  function handleSMCLogic(isChecked) {
    if (!isChecked) return; // Only apply logic on selection

    const rows = document.querySelectorAll('#matTableBody tr');
    
    // 1. Find and Set Smart Meter Installed to YES
    rows.forEach(tr => {
      if(tr.dataset.name === "3-Phase Smart Meter Installed") {
        const ck = tr.querySelector('.mat-check');
        if(!ck.checked) {
          ck.checked = true;
          ck.dispatchEvent(new Event('change')); // Trigger visibility
        }
        tr.querySelector('.mat-val').value = "Yes";
      }
    });

    // 2. Find and Set CT Qty to 4
    rows.forEach(tr => {
      if(tr.dataset.name === "Resin Type Current Transformer (CT)") {
        const ck = tr.querySelector('.mat-check');
        if(!ck.checked) {
          ck.checked = true;
          ck.dispatchEvent(new Event('change'));
        }
        tr.querySelector('.mat-val-count').value = "4";
        // Optional: Force Rating if needed, otherwise user selects rating
      }
    });
  }

  function getOMData() {
    const list = []; let err = null;
    document.querySelectorAll('#matTableBody tr').forEach(tr => {
      const ck = tr.querySelector('.mat-check');
      if(ck.checked) {
        const type = tr.dataset.type;
        const name = tr.dataset.name;
        let obj = { name: name, type: type };

        if (type === 'DROPDOWN_PLUS_DROPDOWN_COUNT') {
           const rating = tr.querySelector('.mat-val-drop').value;
           const count = tr.querySelector('.mat-val-count').value;
           if (!rating || !count) { err = `Please select Rating AND Count for ${name}`; return; }
           obj.rating = rating;
           obj.count = count;
        } else {
           const valEl = tr.querySelector('.mat-val');
           const val = valEl.value.trim();
           if(!val || (type==='COUNT' && val<=0)) { err = `Please complete details for ${name}`; return; }
           
           if(type==='COUNT') obj.count = val;
           else if(type==='DROPDOWN') { obj.rating = val; obj.count = 1; }
        }
        list.push(obj);
      }
    });
    if(err) return { error: err };
    return { data: list };
  }

  function fetchOpts() {
    callApi('getOptions').then(r => {
      circlesByZone=r.circlesByZone; divisionsByPair=r.divisionsByPair;
      remarksByDep=r.remarksByDep; finalsByPair=r.finalsByPair;
      populate('zone', r.zones); populate('dependency', r.dependencies);
      populate('rectStatus', r.rectStatuses); populate('vehReq', r.vehicleOptions);
    });
  }
  function populate(id, list) {
    const el = get(id); el.innerHTML = '<option value="">Select</option>' + (list||[]).map(v=>`<option>${v}</option>`).join('');
    el.disabled = !list || !list.length;
  }
  
  get('zone').onchange = e => { populate('circle', circlesByZone[e.target.value]); populate('division',[]); };
  get('circle').onchange = e => { populate('division', divisionsByPair[`${get('zone').value}||${e.target.value}`]); };
  get('dependency').onchange = e => { populate('remBucket', remarksByDep[e.target.value]); populate('finBucket',[]); };
  get('remBucket').onchange = e => { populate('finBucket', finalsByPair[`${get('dependency').value}||${e.target.value}`]); };
  get('meterNo').oninput = e => { e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,10); };
  
  function handleImg(e, k) {
    const f = e.target.files[0]; if(!f) { imgs[k]=null; get('p_'+k).classList.remove('show'); return; }
    const r = new FileReader();
    r.onload = ev => {
      get('i_'+k).src = ev.target.result; get('p_'+k).classList.add('show');
      const i = new Image();
      i.onload = () => {
        const c = document.createElement('canvas'); const sc = Math.min(1000/i.width, 1000/i.height, 1);
        c.width=i.width*sc; c.height=i.height*sc; c.getContext('2d').drawImage(i,0,0,c.width,c.height);
        imgs[k] = c.toDataURL('image/jpeg',0.6).split(',')[1];
        
        // UNLOCK FLOW TRIGGER
        if(k === 'before') unlockOMFlow();

      }; i.src = ev.target.result;
    }; r.readAsDataURL(f);
  }
  
  get('f_meter').onchange = e => handleImg(e,'meter'); 
  get('f_ct').onchange = e => handleImg(e,'ct'); 
  get('f_dt').onchange = e => handleImg(e,'dt');
  get('f_before').onchange = e => handleImg(e,'before');
  get('f_after').onchange = e => handleImg(e,'after');

  const setLoading = (busy) => {
    const btn = get('btnSave');
    if (busy) {
      btn.disabled = true;
      btn.textContent = 'Processing...';
      btn.style.opacity = '0.7';
    } else {
      btn.disabled = false;
      btn.textContent = 'SUBMIT REPORT';
      btn.style.opacity = '1';
    }
  };

  get('btnSave').onclick = async () => {
    if (get('btnSave').disabled) return;

    const val = id => get(id).value.trim();
    const p = { empCode: currentUser.empCode, zone:val('zone'), circle:val('circle'), division:val('division'), meterNo:val('meterNo'), fieldRemark:val('fieldRemark'), dependency:val('dependency'), remarkBucket:val('remBucket'), finalBucket:val('finBucket'), rectStatus:val('rectStatus') };
    
    if(!p.zone || !p.circle || !p.division || !p.meterNo || !p.dependency || !p.rectStatus) return msg('formMsg','Missing selections','err');
    if(!p.fieldRemark) return msg('formMsg','Field Remark is required','err');
    if(!/^[A-Z]{2}[0-9]{7,8}$/.test(p.meterNo)) return modal('Error','Invalid Meter No format');

    let action = '';
    
    setLoading(true);

    if (currentMode === 'NEW') {
      action = 'submitFinal';
      p.vehicleRequired = val('vehReq');
      p.materialRequired = val('matReq');
      if(!p.materialRequired) { setLoading(false); return msg('formMsg','Material Req is required','err'); }
      if(!imgs.meter || !imgs.ct || !imgs.dt) { setLoading(false); return msg('formMsg','3 Photos Required','err'); }
      p.imageBase64_meter = imgs.meter; p.imageBase64_ct = imgs.ct; p.imageBase64_dtcable = imgs.dt;
      
      submitPayload(action, p);
    
    } else { 
      action = 'submitOM';
      
      const matRes = getOMData();
      if(matRes.error) { setLoading(false); return msg('formMsg', matRes.error, 'err'); }
      if(matRes.data.length === 0) { setLoading(false); return modal('Validation Error', 'You must select at least one material used.'); }
      p.materialData = matRes.data; 
      
      // O&M Vehicle Field Capture
      p.vehicleOM = val('vehicleOM');
      if(!p.vehicleOM) { setLoading(false); return msg('formMsg', 'Please select Vehicle use while O&M', 'err'); }

      if(!imgs.before || !imgs.after) { setLoading(false); return msg('formMsg','Before & After Photos Required','err'); }
      p.imageBase64_before = imgs.before; p.imageBase64_after = imgs.after;

      msg('formMsg', 'Checking history...');
      try {
        const hist = await callApi('checkOMHistory', { meterNo: p.meterNo });
        if (hist.count > 0) {
          const d = hist.lastMeta;
          const nextVisit = hist.count + 1;
          const html = `
            <div class="warn-box" style="border:1px solid #f9ab00; background:#fff8e1;">
               <strong>Already O&M done ${hist.count} times.</strong><br><br>
               <strong>Last Visited By:</strong><br>Name: ${d.name}<br>Role: ${d.designation}<br>Mobile: ${d.mobile}<br>Date: ${d.date}
            </div>
            <p style="font-weight:600; margin-top:10px;">This will be the <span style="color:#1a73e8;font-size:18px;">${nextVisit}th</span> Visit.</p>
            <p>Please confirm submission.</p>`;
          
          modal('Repeat Visit Confirmation', html, true, () => { 
             submitPayload(action, p); 
          }, () => {
             setLoading(false);
          });
          msg('formMsg', ''); 
        } else {
          submitPayload(action, p);
        }
      } catch (e) { 
        setLoading(false);
        msg('formMsg', 'Error checking history: ' + e.message, 'err'); 
      }
    }
  };

  function submitPayload(action, p) {
    msg('formMsg','Saving Report...');
    callApi(action, p).then(res => {
      if(res.ok) {
        msg('formMsg',''); resetForm(); show('view-dashboard');
        modal('Success', 'Report Saved Successfully!');
      } else {
        setLoading(false);
        msg('formMsg', res.message || 'Error', 'err');
      }
    }).catch(e => {
      setLoading(false);
      msg('formMsg', e.message, 'err');
    });
  }

  function resetForm() {
    ['meterNo','fieldRemark','matReq'].forEach(id=>get(id).value='');
    ['zone','dependency','rectStatus','vehReq','vehicleOM'].forEach(id=>get(id).selectedIndex=0);
    get('zone').dispatchEvent(new Event('change'));
    
    document.querySelectorAll('.img-box').forEach(d => d.classList.remove('show'));
    document.querySelectorAll('input[type="file"]').forEach(i => i.value='');
    imgs.meter=null; imgs.ct=null; imgs.dt=null; imgs.before=null; imgs.after=null;
    
    setLoading(false);
    get('dupWarning').textContent = '';
    
    get('om-flow-locked').classList.remove('unlocked');
    window.scrollTo(0,0);
  }

  function modal(t, tx, showCancel=false, onConfirm=null, onCancel=null) { 
    get('mTitle').textContent=t; get('mBody').innerHTML=tx; 
    const btnCancel = get('mCancel'); const btnOk = get('mOk');
    if(showCancel) {
      btnCancel.style.display = 'inline-block';
      
      btnCancel.onclick = () => { 
        get('modal').classList.remove('open'); 
        if(onCancel) onCancel(); 
      };
      
      btnOk.textContent = 'CONFIRM & SUBMIT';
      btnOk.onclick = () => { 
        get('modal').classList.remove('open'); 
        if(onConfirm) onConfirm(); 
      };
    } else {
      btnCancel.style.display = 'none'; btnOk.textContent = 'OK';
      btnOk.onclick = () => get('modal').classList.remove('open');
    }
    get('modal').classList.add('open'); 
  }
  
  get('btnToReset').onclick = () => show('view-reset');
  initAuth();
</script>
</body>
</html>
