<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DI Port Entry System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Color Scheme */
        :root { 
            --primary-blue: #2c5282; 
            --hover-blue: #1a365d;
            --green: #8CC63E; 
            --red: #DC2626; 
            --bg: #F7F9FC; 
            --white: #ffffff; 
            --text-dark: #2D3748;
            --text-light: #718096;
            --border-color: #E2E8F0;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text-dark); }
        
        /* Layout & Utilities */
        .wrapper { min-height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        .p-4 { padding: 20px; }
        
        /* Login View */
        .login-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-card {
            background: var(--white);
            padding: 40px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .login-logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 30px;
        }
        .login-logo span { color: var(--green); } 

        /* Dashboard View */
        .dashboard-header {
            background: var(--primary-blue);
            color: var(--white);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title h1 { font-size: 1.2rem; font-weight: 600; }
        .header-title small { font-size: 0.8rem; opacity: 0.8; }
        
        .dashboard-content {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        /* Header Icons */
        .header-actions { display: flex; gap: 15px; }
        .icon-btn {
            background: transparent;
            border: none;
            color: var(--white);
            font-size: 1.3rem;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            opacity: 0.8;
            transition: opacity 0.2s, transform 0.2s;
        }
        .icon-btn:hover { opacity: 1; transform: scale(1.05); }
        .icon-btn .tooltip {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-5px);
            transition: all 0.2s ease-in-out;
            margin-top: 8px;
        }
        .icon-btn:hover .tooltip { opacity: 1; transform: translateY(0); }

        /* Forms */
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; font-weight: 500; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-dark); }
        input, select, textarea { 
            width: 100%; 
            padding: 12px 15px; 
            border: 1px solid var(--border-color); 
            border-radius: 6px;
            font-size: 0.95rem; 
            color: var(--text-dark);
            transition: border-color 0.2s;
            background: var(--white);
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-blue); }
        input::placeholder, textarea::placeholder { color: #A0AEC0; }

        /* Buttons */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background 0.2s; font-size: 1rem; }
        .btn-primary { background: var(--primary-blue); color: white; }
        .btn-primary:hover { background: var(--hover-blue); }
        .btn-green { background: var(--green); color: white; }
        .btn-green:hover { background: #7ab633; }
        
        .password-wrapper { position: relative; }
        .eye-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-light); }
        #queue-banner { background: #FEF3C7; color: #92400E; padding: 10px; text-align: center; font-size: 0.9rem; font-weight: 600; display: none; position: sticky; top: 0; z-index: 10; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .modal { background: white; padding: 24px; border-radius: 12px; max-width: 90%; width: 400px; text-align: left; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .modal h3 { color: var(--primary-blue); margin-bottom: 15px; }
        .btn-close { background: var(--red); color: white; margin-top: 15px; }
        .btn-outline { background: transparent; border: 1px solid var(--primary-blue); color: var(--primary-blue); }

        /* Enhanced Duplicate Popup Styles */
        .dup-info-box {
            background: #FEF2F2;
            border: 1px solid #FECACA;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 10px;
        }
        .dup-row { display: flex; flex-direction: column; }
        .dup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .dup-label {
            font-size: 0.75rem; color: #991B1B; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;
        }
        .dup-value {
            font-size: 1.05rem; color: #111827; font-weight: 500; line-height: 1.4;
        }
        .dup-remark-box {
            background: rgba(255,255,255, 0.6);
            border-left: 4px solid var(--red);
            padding: 10px 12px;
            border-radius: 4px;
            font-size: 0.95rem;
            color: #374151;
            font-style: italic;
        }
    </style>
</head>
<body>

<div id="queue-banner">Syncing data...</div>

<div class="wrapper">
    <div id="view-login" class="login-container">
        <div class="login-card">
            <div class="login-logo">Pa<span>s</span>chimanchal Infra</div>
            <div class="form-group">
                <label for="login-emp">User name*</label>
                <input type="number" id="login-emp" placeholder="Enter Employee Code">
            </div>
            <div class="form-group">
                <label for="login-pass">Password*</label>
                <div class="password-wrapper">
                    <input type="password" id="login-pass" placeholder="Enter Password">
                    <span class="eye-icon" onclick="togglePass('login-pass')">üëÅÔ∏è</span>
                </div>
            </div>
            <button class="btn btn-primary" onclick="doLogin()" id="btn-login">Login</button>
            <div id="login-msg" style="color:var(--red); margin-top:15px; font-size: 0.9rem;"></div>
        </div>
    </div>

    <div id="view-dashboard" class="hidden">
        <div class="dashboard-header">
            <div class="header-title">
                <h1 id="user-welcome">Welcome</h1>
                <small>DI Port Entry V2.1</small>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="showChangePass()">
                    üîë <span class="tooltip">Change Password</span>
                </button>
                <button class="icon-btn" onclick="logout()">
                    üö™ <span class="tooltip">Logout</span>
                </button>
            </div>
        </div>

        <div class="dashboard-content p-4">
            <div class="form-group">
                <label>Zone*</label>
                <select id="in-zone" onchange="filterCircles()"><option value="">Select Zone</option></select>
            </div>
            <div class="form-group">
                <label>Circle*</label>
                <select id="in-circle" onchange="filterDivisions()" disabled><option value="">Select Circle first</option></select>
            </div>
            <div class="form-group">
                <label>Division*</label>
                <select id="in-div" onchange="filterSubs()" disabled><option value="">Select Division first</option></select>
            </div>
            <div class="form-group">
                <label>Substation Name*</label>
                <select id="in-sub" disabled><option value="">Select Substation first</option></select>
            </div>

            <div class="form-group">
                <label>Feeder Name*</label>
                <input type="text" id="in-feeder" placeholder="Enter feeder name" oninput="this.value = this.value.toUpperCase()">
            </div>
            <div class="form-group">
                <label>Meter Number*</label>
                <input type="text" id="in-meter" maxlength="9" placeholder="e.g., HP1234567 (exactly 9 chars)" oninput="cleanMeter(this)">
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: 2 Letters + 7 Numbers</small>
            </div>
            <div class="form-group">
                <label>DI Port Number*</label>
                <input type="number" id="in-diport" placeholder="Enter port number">
            </div>
            <div class="form-group">
                <label>Book Number*</label>
                <input type="number" id="in-book" placeholder="Enter book value">
            </div>
            <div class="form-group">
                <label>Page Number*</label>
                <input type="number" id="in-page" placeholder="Enter page value">
            </div>
            <div class="form-group">
                <label>Remark*</label>
                <textarea id="in-remark" rows="3" placeholder="Enter remarks here..."></textarea>
            </div>

            <button class="btn btn-green" onclick="queueSubmission()">Submit Entry</button>
        </div>
    </div>
</div>

<div id="modal-pass" class="modal-overlay hidden">
    <div class="modal">
        <h3>Change Password</h3>
        <div class="form-group">
            <label>Old Password</label>
            <input type="password" id="cp-old" placeholder="Current password">
        </div>
        <div class="form-group">
            <label>New Password</label>
            <div class="password-wrapper">
                <input type="password" id="cp-new" placeholder="New password">
                <span class="eye-icon" onclick="togglePass('cp-new')">üëÅÔ∏è</span>
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="doChangePass()">Update</button>
            <button class="btn btn-outline" onclick="document.getElementById('modal-pass').classList.add('hidden')">Cancel</button>
        </div>
    </div>
</div>

<div id="modal-dup" class="modal-overlay hidden">
    <div class="modal" style="border-left: 5px solid var(--red);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
             <div style="font-size: 1.5rem;">‚õî</div>
             <div><h2 style="color: var(--red); margin: 0; font-size: 1.4rem;">DUPLICATE ENTRY</h2></div>
        </div>
        <p id="dup-msg" style="color: var(--red); font-weight: 600; margin-bottom: 20px; font-size: 1rem; line-height: 1.4;"></p>
        
        <div class="dup-info-box">
            <div class="dup-row">
                <span class="dup-label">Meter Number</span>
                <span class="dup-value" id="d-meter" style="font-weight: 700; font-family: monospace; font-size: 1.1rem;"></span>
            </div>
            <div class="dup-grid">
                <div class="dup-row">
                    <span class="dup-label">Installer Name</span>
                    <span class="dup-value" id="d-installer"></span>
                </div>
                <div class="dup-row">
                    <span class="dup-label">Mobile Number</span>
                    <span class="dup-value" id="d-mobile"></span>
                </div>
            </div>
            <div class="dup-row">
                <span class="dup-label">Installation Date</span>
                <span class="dup-value" id="d-date"></span>
            </div>
            <div class="dup-row">
                <span class="dup-label">Remark</span>
                <div class="dup-remark-box" id="d-remark"></div>
            </div>
        </div>
        <button class="btn btn-close" onclick="document.getElementById('modal-dup').classList.add('hidden')">Close</button>
    </div>
</div>

<script>
    // ================= CONFIGURATION =================
    // ‚úÖ PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE
    const API_URL = "https://script.google.com/macros/s/AKfycbwNUp6JHA14u6Egj_oVBvkbc6gkwvJlxGLRnNMCWbsuKyDaC4r34_ntrRgCzKLTGOn52w/exec"; 
    // =================================================

    let currentUser = JSON.parse(localStorage.getItem('di_user')) || null;
    let dropdownData = [];
    let submissionQueue = [];
    let isProcessingQueue = false;

    // --- INIT ---
    window.addEventListener('DOMContentLoaded', () => {
        if (currentUser) {
            document.getElementById('view-login').classList.add('hidden');
            initDashboard();
        } else {
            document.getElementById('view-login').classList.remove('hidden');
            document.getElementById('view-dashboard').classList.add('hidden');
        }
    });

    // --- AUTHENTICATION ---
    async function doLogin() {
        const emp = document.getElementById('login-emp').value;
        const pass = document.getElementById('login-pass').value;
        const btn = document.getElementById('btn-login');
        const msg = document.getElementById('login-msg');

        if(!emp || !pass) { msg.innerText = "Please enter username and password."; return; }

        btn.innerText = "Verifying..."; btn.disabled = true; msg.innerText = "";

        try {
            const res = await callApi({ action: 'LOGIN', empCode: emp, password: pass });
            if (res.status === 'success') {
                currentUser = res.user;
                localStorage.setItem('di_user', JSON.stringify(currentUser));
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('login-emp').value = '';
                document.getElementById('login-pass').value = '';
                initDashboard();
            } else {
                msg.innerText = res.message;
            }
        } catch (e) {
            msg.innerText = "Connection Failed. Please check internet.";
        }
        btn.innerText = "Login"; btn.disabled = false;
    }

    function logout() {
        if(confirm("Are you sure you want to logout?")) {
            localStorage.removeItem('di_user');
            location.reload();
        }
    }

    async function doChangePass() {
        const oldP = document.getElementById('cp-old').value;
        const newP = document.getElementById('cp-new').value;
        if(!oldP || !newP) return alert("Please fill all fields");

        const res = await callApi({ action: 'CHANGE_PASS', empCode: currentUser.empCode, oldPassword: oldP, newPassword: newP });
        if(res.status === 'success') {
            alert("Password Changed. Login again.");
            localStorage.removeItem('di_user');
            location.reload();
        } else {
            alert(res.message);
        }
    }

    // --- DASHBOARD ---
    async function initDashboard() {
        document.getElementById('view-dashboard').classList.remove('hidden');
        document.getElementById('user-welcome').innerText = `Hello, ${currentUser.name.split(' ')[0]}`;
        
        if(dropdownData.length === 0) {
            try {
                const res = await callApi({ action: 'GET_OPTIONS' });
                if(res.status === 'success') {
                    dropdownData = res.data;
                    populateZones();
                }
            } catch(e) { alert("Failed to load options. Refresh page."); }
        }
    }

    // --- DROPDOWN LOGIC ---
    function populateZones() {
        const zones = [...new Set(dropdownData.map(r => r[0]))].filter(Boolean).sort();
        document.getElementById('in-zone').innerHTML = '<option value="">Select Zone</option>' + zones.map(z => `<option>${z}</option>`).join('');
        resetDependentDropdowns('circle');
    }

    function filterCircles() {
        const z = document.getElementById('in-zone').value;
        resetDependentDropdowns('circle');
        if(!z) return;
        const circles = [...new Set(dropdownData.filter(r => r[0] === z).map(r => r[1]))].filter(Boolean).sort();
        const el = document.getElementById('in-circle');
        el.innerHTML = '<option value="">Select Circle</option>' + circles.map(c => `<option>${c}</option>`).join('');
        el.disabled = false;
    }

    function filterDivisions() {
        const z = document.getElementById('in-zone').value;
        const c = document.getElementById('in-circle').value;
        resetDependentDropdowns('div');
        if(!z || !c) return;
        const divs = [...new Set(dropdownData.filter(r => r[0] === z && r[1] === c).map(r => r[2]))].filter(Boolean).sort();
        const el = document.getElementById('in-div');
        el.innerHTML = '<option value="">Select Division</option>' + divs.map(d => `<option>${d}</option>`).join('');
        el.disabled = false;
    }

    function filterSubs() {
        const z = document.getElementById('in-zone').value;
        const c = document.getElementById('in-circle').value;
        const d = document.getElementById('in-div').value;
        resetDependentDropdowns('sub');
        if(!z || !c || !d) return;
        const subs = [...new Set(dropdownData.filter(r => r[0] === z && r[1] === c && r[2] === d).map(r => r[3]))].filter(Boolean).sort();
        const el = document.getElementById('in-sub');
        el.innerHTML = '<option value="">Select Substation</option>' + subs.map(s => `<option>${s}</option>`).join('');
        el.disabled = false;
    }

    function resetDependentDropdowns(level) {
        const circle = document.getElementById('in-circle');
        const div = document.getElementById('in-div');
        const sub = document.getElementById('in-sub');
        if (level === 'circle' || level === 'all') { circle.innerHTML = '<option value="">Select Circle first</option>'; circle.disabled = true; }
        if (level === 'div' || level === 'circle' || level === 'all') { div.innerHTML = '<option value="">Select Division first</option>'; div.disabled = true; }
        if (level === 'sub' || level === 'div' || level === 'circle' || level === 'all') { sub.innerHTML = '<option value="">Select Substation first</option>'; sub.disabled = true; }
    }

    // --- SUBMISSION ---
    function queueSubmission() {
        const required = ['in-zone', 'in-circle', 'in-div', 'in-sub', 'in-feeder', 'in-meter', 'in-diport', 'in-book', 'in-page', 'in-remark'];
        for(let id of required) { if(!document.getElementById(id).value.trim()) return alert("Please fill all required fields."); }

        const meterVal = document.getElementById('in-meter').value;
        if (!/^[A-Z]{2}[0-9]{7}$/.test(meterVal)) return alert("Invalid Meter format. Must be 2 Letters + 7 Numbers.");

        const payload = {
            zone: document.getElementById('in-zone').value,
            circle: document.getElementById('in-circle').value,
            division: document.getElementById('in-div').value,
            subStation: document.getElementById('in-sub').value,
            feeder: document.getElementById('in-feeder').value,
            meterNo: meterVal,
            diPort: document.getElementById('in-diport').value,
            book: document.getElementById('in-book').value,
            page: document.getElementById('in-page').value,
            remark: document.getElementById('in-remark').value,
            empCode: currentUser.empCode,
            mobile: currentUser.mobile,
            installer: currentUser.name
        };

        submissionQueue.push(payload);
        processQueue();
        clearForm();
    }

    async function processQueue() {
        if(isProcessingQueue || submissionQueue.length === 0) return;
        isProcessingQueue = true;
        const banner = document.getElementById('queue-banner');
        banner.style.display = 'block';
        banner.innerText = submissionQueue.length > 1 ? `Syncing ${submissionQueue.length} records...` : "Submitting entry...";

        try {
            const res = await callApi({ action: 'SUBMIT', payload: submissionQueue[0] });
            if (res.status === 'success') {
                submissionQueue.shift();
            } else if (res.status === 'duplicate') {
                submissionQueue.shift();
                showDuplicateModal(res.details);
            } else {
                alert("Server Error: " + res.message);
            }
        } catch (e) {
             banner.innerText = "Connection lost. Retrying...";
        } finally {
             isProcessingQueue = false;
             if(submissionQueue.length === 0) {
                 banner.style.display = 'none';
                 alert("Submission Complete!");
             } else {
                 setTimeout(processQueue, 1000);
             }
        }
    }

    function showDuplicateModal(d) {
        document.getElementById('dup-msg').innerText = d.errorMsg || "Duplicate found.";
        document.getElementById('d-meter').innerText = d.meterNo || "N/A";
        document.getElementById('d-installer').innerText = d.installer || "N/A";
        document.getElementById('d-mobile').innerText = d.mobile || "N/A";
        document.getElementById('d-date').innerText = d.date || "N/A";
        document.getElementById('d-remark').innerText = d.remark || "";
        document.getElementById('modal-dup').classList.remove('hidden');
    }

    // --- UTILS ---
    async function callApi(data) {
        const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
    }

    function cleanMeter(el) {
        let val = el.value.toUpperCase();
        let newVal = '';
        for(let i = 0; i < val.length && i < 9; i++) {
            if (i < 2) { if (/[A-Z]/.test(val[i])) newVal += val[i]; }
            else { if (/[0-9]/.test(val[i])) newVal += val[i]; }
        }
        if (el.value !== newVal) el.value = newVal;
    }

    function clearForm() {
        ['in-feeder', 'in-meter', 'in-diport', 'in-book', 'in-page', 'in-remark'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('in-zone').value = "";
        resetDependentDropdowns('all');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function togglePass(id) { const el = document.getElementById(id); el.type = el.type === 'password' ? 'text' : 'password'; }
    function showChangePass() { document.getElementById('modal-pass').classList.remove('hidden'); }
</script>

</body>
</html>